<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dozone.wehagopro.repository.mybatis.OrganizationMapper">
    <select id="showMyWorkPlace">
        SELECT
        t_company.t_company_no,
        t_company.t_company_name,
        t_organization.t_organization_no,
        t_organization.t_organization_name,
        (
        SELECT COUNT(t_employee_no) FROM t_employee WHERE t_company_no = t_company.t_company_no AND t_employee_state >= 0
        ) AS company_employee_count,
        (
        SELECT COUNT(t_employee_no) FROM t_employee WHERE t_organization_no = t_organization.t_organization_no AND t_employee_state >= 0
        ) AS organization_employee_count
        FROM
        t_organization
        JOIN
        t_employee ON t_organization.t_organization_parent = t_employee.t_company_no
        JOIN
        t_company ON t_employee.t_company_no = t_company.t_company_no
        WHERE
        t_employee.t_user_no = #{t_user_no};
    </select>
    <select id="showMyEmployeeState" resultType="OrganizationInitEmplDTO">
        SELECT
        (
        SELECT COUNT(t_employee_no)
        FROM t_employee
        WHERE t_company_no = #{t_company_no} AND t_employee_state >= 0
        ) AS count_state_all,
        (
        SELECT COUNT(t_employee_no)
        FROM t_employee
        WHERE t_company_no = #{t_company_no} AND t_employee_state = 0
        ) AS count_state_0,
        (
        SELECT COUNT(t_employee_no)
        FROM t_employee
        WHERE t_company_no = #{t_company_no} AND t_employee_state = 1
        ) AS count_state_1,
        (
        SELECT COUNT(t_employee_no)
        FROM t_employee
        WHERE t_company_no = #{t_company_no} AND t_employee_state = 2
        ) AS count_state_2,
        (
        SELECT COUNT(t_employee_no)
        FROM t_employee
        WHERE t_company_no = #{t_company_no} AND t_employee_state = 3
        ) AS count_state_3;
    </select>
    <select id="showMyEmployeeFromCompany" resultType="UserDTO">
        SELECT * FROM t_user WHERE t_user_no IN
        (SELECT t_user_no FROM t_employee WHERE t_company_no=
        (SELECT t_company_no FROM t_company WHERE t_company_name=#{t_company_name} AND t_company_no=#{t_company_no})
        AND
        <choose>
            <when test="t_employee_state == 0">
                t_employee_state = 0
            </when>
            <when test="t_employee_state == 1">
                t_employee_state = 1
            </when>
            <when test="t_employee_state == 2">
                t_employee_state = 2
            </when>
            <when test="t_employee_state == 3">
                t_employee_state = 3
            </when>
            <otherwise>
                t_employee_state >= 0
            </otherwise>
        </choose>
        )
        AND t_user_state>=0;
    </select>
    <select id="showMyEmployeeFromOrganization" resultType="UserDTO">
        SELECT * FROM t_user WHERE t_user_no IN
        (SELECT t_user_no FROM t_employee WHERE t_organization_no=
        (SELECT t_organization_no FROM t_organization WHERE t_organization_name=#{t_organization_name} AND t_organization_no=#{t_organization_no})
        AND
        <choose>
            <when test="t_employee_state == 0">
                t_employee_state = 0
            </when>
            <when test="t_employee_state == 1">
                t_employee_state = 1
            </when>
            <when test="t_employee_state == 2">
                t_employee_state = 2
            </when>
            <when test="t_employee_state == 3">
                t_employee_state = 3
            </when>
            <otherwise>
                t_employee_state >= 0
            </otherwise>
        </choose>
        )
        AND t_user_state>=0;
    </select>
    <insert id="createOrganization">
        INSERT INTO t_organization (t_organization_name, t_organization_parent)
        VALUES (#{t_organization_name}, #{t_company_no});
    </insert>
    <update id="updateOrganization">
        UPDATE t_organization SET t_organization_name = #{t_organization_name} WHERE t_organization_no = #{t_organization_no};
    </update>
    <delete id="deleteOrganization">
        DELETE FROM t_organization WHERE t_organization_no = #{t_organization_no};
    </delete>
</mapper>